<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô | Web GIS</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Locate Control -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

<!-- Mouse Position Plugin -->
<link rel="stylesheet" href="L.Control.MousePosition.css"/>
<script src="L.Control.MousePosition.js"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{--accent:#e6b330;}
body{font-family:'Sarabun',sans-serif;margin:0;padding-top:60px;background:#0f1724;color:#eef2f7;}
.main-header{display:flex;justify-content:space-between;align-items:center;padding:18px 60px;position:fixed;top:0;left:0;right:0;background:rgba(15,23,36,0.9);backdrop-filter:blur(8px);z-index:1000;}
.logo a{font-size:24px;font-weight:700;color:var(--accent);text-decoration:none;letter-spacing:3px;}
.main-nav ul{list-style:none;display:flex;margin:0;}
.main-nav li{margin-left:32px;}
.main-nav a{text-decoration:none;color:#e0d7b8;transition:color .3s ease;}
.main-nav a:hover{color:#fff;}
.page-title{text-align:center;font-size:36px;font-weight:700;color:var(--accent);margin-top:90px;}
.page-intro{text-align:center;padding:15px 20px;font-size:18px;color:#fcefb4;}
.map-container{display:flex;flex-wrap:wrap;justify-content:center;align-items:flex-start;margin-top:10px;}
#map{height:590px;width:770px;margin:25px;border-radius:10px;border:1.5px solid var(--accent);}
#dataTableContainer{flex:1;margin:25px;padding:20px;background:rgba(255,255,255,0.05);border-radius:10px;border:1px solid rgba(255,255,255,0.08);overflow-y:auto;max-height:590px;width:400px;color:#fcefb4;}
#tableFilter{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin-bottom:10px;}
#tableFilter select, #tableFilter input{padding:6px 10px;border-radius:6px;background-color: rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.2);color:#fff;font-weight:600;}
#dataTableContainer h3{text-align:center;font-size:20px;font-weight:600;color:var(--accent);margin-bottom:10px;}
.pagination{text-align:center;margin-top:10px;display:flex;justify-content:center;gap:5px;}
.pagination button{margin:2px;padding:5px 10px;background:rgba(255,255,255,0.1);border:none;color:#fff;border-radius:4px;cursor:pointer;}
.pagination button.active{background:var(--accent);color:#000;}

/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
#dataTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 14px;
}
#dataTable th, #dataTable td {
  border: 1px solid rgba(255,255,255,0.15);
  padding: 6px 8px;
  text-align: left;
  color: #fcefb4;
}
#dataTable th {
  background: linear-gradient(90deg, #b8922e, #e6b330);
  color: #0f1724;
  text-align: center;
  font-weight: 700;
  padding: 10px;
}

/* ‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏û */
.leaflet-popup-content-wrapper {
  background: rgba(15,23,36,0.95);
  border-radius: 8px;
  border: 2px solid var(--accent);
  color: #fcefb4;
  font-size: 14px;
  padding: 8px 12px;
}
.leaflet-popup-content h3 {margin:0;font-size:16px;color:var(--accent);}
.leaflet-popup-content p {margin:2px 0;}

/* ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏≤‡∏ü */
.chart-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
  gap: 20px;
  margin: 40px;
}
.chart-card {
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.1);
  padding: 15px;
  color: #fcefb4;
  text-align: center;
}
.chart-card h4 {
  color: var(--accent);
  margin-bottom: 10px;
}
canvas {
  background: rgba(255,255,255,0.05);
  border-radius: 6px;
}
</style>
</head>

<body>
<header class="main-header">
  <div class="logo"><a href="index.html">TenJO</a></div>
  <nav class="main-nav">
    <ul>
        <li><a href="tourist.html">‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</a></li>
        <li><a href="studeut.html">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a></li>
    </ul>
  </nav>
</header>

<h1 class="page-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
<div class="page-intro">‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≤‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>

<div class="map-container">
  <div id="map"></div>
  <div id="dataTableContainer">
    <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
    <div id="tableFilter">
      <select id="filterType">
        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="2564">‡∏õ‡∏µ 2564</option>
        <option value="2565">‡∏õ‡∏µ 2565</option>
        <option value="2566">‡∏õ‡∏µ 2566</option>
        <option value="2567">‡∏õ‡∏µ 2567</option>
      </select>
      <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡∏Ñ‡∏ì‡∏∞, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î...">
    </div>
    <table id="dataTable">
      <thead>
        <tr>
          <th>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏¥‡∏™‡∏¥‡∏ï</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠</th>
          <th>‡∏õ‡∏µ</th>
          <th>‡∏™‡∏≤‡∏Ç‡∏≤</th>
          <th>‡∏†‡∏≤‡∏Ñ‡∏ß‡∏¥‡∏ä‡∏≤</th>
          <th>‡∏Ñ‡∏ì‡∏∞</th>
          <th>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
          <th>‡∏ï‡∏≥‡∏ö‡∏•</th>
          <th>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</th>
          <th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="pagination" id="pagination"></div>
  </div>
</div>

<!-- üîπ ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü -->
<div class="chart-section">
  <div class="chart-card">
    <h4>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏µ</h4>
    <canvas id="yearChart"></canvas>
  </div>
  <div class="chart-card">
    <h4>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤</h4>
    <canvas id="majorChart"></canvas>
  </div>
  <div class="chart-card">
    <h4>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏Ñ‡∏ß‡∏¥‡∏ä‡∏≤</h4>
    <canvas id="deptChart"></canvas>
  </div>
  <div class="chart-card">
    <h4>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</h4>
    <canvas id="provinceChart"></canvas>
  </div>
</div>

<script>
let allData = [], markers = [], currentPage = 1, rowsPerPage = 10;
let yearChart, majorChart, deptChart, provinceChart;

const mymap = L.map('map').setView([7.561018, 99.561093], 18);
var google_map = L.tileLayer('https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}', {maxZoom:18});
var openstreetmap = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:18}).addTo(mymap);
var EsriWorldStreetMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {maxZoom:18});
var EsriWorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:18});

L.control.layers({
    "Google Map": google_map,
    "OpenStreetMap": openstreetmap,
    "Esri World StreetMap": EsriWorldStreetMap,
    "Esri World Imagery": EsriWorldImagery
}).addTo(mymap);

L.control.locate({position:'topleft', strings:{title:"‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô"}}).addTo(mymap);
L.control.mousePosition().addTo(mymap);

function filterData(){
  const selected = document.getElementById('filterType').value;
  const search = document.getElementById('searchInput').value.toLowerCase();
  return allData.filter(item => {
    const year = '25'+item["‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó"].slice(3);
    const matchYear = (selected==='all' || year===selected);
    const matchSearch = Object.values(item).some(v=>v && v.toString().toLowerCase().includes(search));
    return matchYear && matchSearch;
  });
}

function renderMarkers(){
  markers.forEach(m => m.remove());
  markers = [];
  filterData().forEach(item=>{
    if(item["‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î"] && item["‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏à‡∏π‡∏î"]){
      const m = L.marker([item["‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î"], item["‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏à‡∏π‡∏î"]], {studentId: item["id"]})
        .bindPopup(`<h3>${item["‡∏ä‡∏∑‡πà‡∏≠"]}</h3>
        <p><strong>‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£:</strong> ${item["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"]}</p>
        <p><strong>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> ${item["‡∏à‡∏ö‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"]}</p>
        <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${item["‡∏ï‡∏≥‡∏ö‡∏•"]}, ${item["‡∏≠‡∏≥‡πÄ‡∏†‡∏≠"]}, ${item["‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"]}</p>`)
        .addTo(mymap);

      m.on('dblclick', ()=>{
        const tableBody = document.querySelector("#dataTable tbody");
        tableBody.innerHTML = "";
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item["id"]}</td>
          <td>${item["‡∏ä‡∏∑‡πà‡∏≠"]}</td>
          <td>${'25'+item["‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó"].slice(3)}</td>
          <td>${item["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"]}</td>
          <td>${item["‡∏†‡∏≤‡∏Ñ‡∏ß‡∏¥‡∏ä‡∏≤"]}</td>
          <td>${item["‡∏Ñ‡∏ì‡∏∞"]}</td>
          <td>${item["‡∏à‡∏ö‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"]}</td>
          <td>${item["‡∏ï‡∏≥‡∏ö‡∏•"]}</td>
          <td>${item["‡∏≠‡∏≥‡πÄ‡∏†‡∏≠"]}</td>
          <td>${item["‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"]}</td>
        `;
        tableBody.appendChild(row);
      });

      markers.push(m);
    }
  });
}

function renderTable(){
  const tableBody = document.querySelector("#dataTable tbody");
  const pagination = document.getElementById("pagination");
  const filteredData = filterData();
  const start = (currentPage-1)*rowsPerPage;
  const end = start+rowsPerPage;
  const pageData = filteredData.slice(start,end);

  tableBody.innerHTML = "";
  pageData.forEach(item=>{
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${item["id"]}</td>
      <td>${item["‡∏ä‡∏∑‡πà‡∏≠"]}</td>
      <td>${'25'+item["‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó"].slice(3)}</td>
      <td>${item["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"]}</td>
      <td>${item["‡∏†‡∏≤‡∏Ñ‡∏ß‡∏¥‡∏ä‡∏≤"]}</td>
      <td>${item["‡∏Ñ‡∏ì‡∏∞"]}</td>
      <td>${item["‡∏à‡∏ö‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"]}</td>
      <td>${item["‡∏ï‡∏≥‡∏ö‡∏•"]}</td>
      <td>${item["‡∏≠‡∏≥‡πÄ‡∏†‡∏≠"]}</td>
      <td>${item["‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"]}</td>
    `;
    tableBody.appendChild(row);

    row.addEventListener("click", ()=>{
      const marker = markers.find(m => m.options.studentId === item["id"]);
      if(marker){ mymap.setView(marker.getLatLng(),16); marker.openPopup(); }
    });
  });

  pagination.innerHTML="";
  const totalPages = Math.ceil(filteredData.length/rowsPerPage);
  for(let i=1;i<=totalPages;i++){
    const btn = document.createElement("button");
    btn.innerText=i;
    if(i===currentPage) btn.classList.add("active");
    btn.addEventListener("click",()=>{currentPage=i; renderTable(); renderMarkers(); renderCharts();});
    pagination.appendChild(btn);
  }
}

function renderCharts(){
  const data = filterData();
  const yearCount = {}, majorCount = {}, deptCount = {}, provinceCount = {};

  data.forEach(item=>{
    const year = '25'+item["‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó"].slice(3);
    yearCount[year] = (yearCount[year]||0)+1;
    majorCount[item["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"]] = (majorCount[item["‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£"]]||0)+1;
    deptCount[item["‡∏†‡∏≤‡∏Ñ‡∏ß‡∏¥‡∏ä‡∏≤"]] = (deptCount[item["‡∏†‡∏≤‡∏Ñ‡∏ß‡∏¥‡∏ä‡∏≤"]]||0)+1;
    provinceCount[item["‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"]] = (provinceCount[item["‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"]]||0)+1;
  });

  updateChart(yearChart, 'yearChart', yearCount, 'bar', '‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤');
  updateChart(majorChart, 'majorChart', majorCount, 'pie', '‡∏™‡∏≤‡∏Ç‡∏≤');
  updateChart(deptChart, 'deptChart', deptCount, 'doughnut', '‡∏†‡∏≤‡∏Ñ‡∏ß‡∏¥‡∏ä‡∏≤');
  updateChart(provinceChart, 'provinceChart', provinceCount, 'bar', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î');
}

function updateChart(chart, id, dataset, type, label){
  const ctx = document.getElementById(id).getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: type,
    data: {
      labels: Object.keys(dataset),
      datasets: [{
        label: label,
        data: Object.values(dataset),
        backgroundColor: ['#e6b330','#ffcf56','#b8922e','#f6e27a','#fcefb4'],
        borderColor: '#fff',
        borderWidth: 1
      }]
    },
    options: {
      plugins: { legend: { labels:{ color:'#fff' } } },
      scales: type==='bar' ? {x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}} : {}
    }
  });
  if(id==='yearChart') yearChart=chart;
  if(id==='majorChart') majorChart=chart;
  if(id==='deptChart') deptChart=chart;
  if(id==='provinceChart') provinceChart=chart;
}

fetch('get_students.php')
  .then(resp => resp.json())
  .then(data => { allData=data; renderMarkers(); renderTable(); renderCharts(); })
  .catch(err => console.error('Error fetching data:', err));

document.getElementById('filterType').addEventListener('change',()=>{currentPage=1; renderTable(); renderMarkers(); renderCharts();});
document.getElementById('searchInput').addEventListener('input',()=>{currentPage=1; renderTable(); renderMarkers(); renderCharts();});

</script>
</body>
</html>
